#!/bin/bash
#
# onodera - onodera at openmailbox dot org
# Like pkgmk but for dependencies

## CONFIGURATION

depmkdir="/home/onodera/etc/depmk"

## FUNCTIONS

# This function gets some basic info
info() {
	ports="$(ports -l)"
	installed="$(pkginfo -i | cut -d " " -f 1)"

	alias=$(cat "$depmkdir/alias")
}

# This function locates the Pkgfile
pkgfile() {
	if ! [[ -f "./Pkgfile" ]]; then
		echo "=======> ERROR: File 'Pkgfile' not found."
		exit 1
	else
		pkgfile="$(cat "./Pkgfile")"
	fi
}

# This function calculates the dependencies
dependencies() {
	deps="$(echo "$pkgfile" | grep "^# Depends on:" | sed "s/# Depends on: *//g" | tr -d "," | tr " " "\n")"

	# Aliasses
	for line in $alias; do
		original="$(echo "$line" | cut -d "=" -f 1)"
		aliased="$(echo "$line" | cut -d "=" -f 2)"

		deps="$(echo "$deps" | sed "s/^$original$/$aliased/g")"
	done

	installme="$(echo "$(echo "$installed $deps" | sort | uniq -u) $deps" | sort | uniq -d)"
}

## EXECUTE

info
pkgfile
dependencies

# install dependencies
for dep in $installme; do
	# Get dependency location and cd to it
	location="$(echo "$ports" | grep "/$dep$")"
	cd "/usr/ports/$location"

	# install dependency
	echo "pkgmk -d -i $dep"
done
